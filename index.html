<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Explora - Registro de Mantenciones</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<style>
body {
  font-family: Inter, Arial, sans-serif;
  background: #f0f4f8;
  padding: 20px;
}

h2, h3 { margin-bottom: 10px; }

label {
  font-size: 13px;
}

input, select, textarea, button {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
}

button {
  background: #2563eb;
  color: white;
  border: none;
  cursor: pointer;
}

button:hover {
  background: #1d4ed8;
}

.card {
  background: white;
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  border: 1px solid #ddd;
}

#qr img {
  margin-top: 10px;
  width: 180px;
}
</style>
</head>

<body>

<h2> Registro de Mantenci贸n de Radios - Explora</h2>

<div class="card">
  <h3>ID del equipo</h3>
  <label>ID (solo si el radio ya existe, si no dejar vac铆o)</label>
  <input id="id_radio" placeholder="Ej: RADIO-1732456789000">
</div>

<div class="card">
  <h3>Datos del servicio</h3>

  <label>Empresa</label>
  <input id="empresa">

  <label>Solicitante</label>
  <input id="solicitante">

  <label>OC</label>
  <input id="oc">

  <label>Lugar operaci贸n</label>
  <input id="lugar">

  <label>Nombre t茅cnico</label>
  <input id="tecnico">

  <label>Motivo intervenci贸n</label>
  <select id="motivo">
    <option>Instalaci贸n</option>
    <option>Mantenci贸n</option>
    <option>Retiro</option>
    <option>Revisi贸n</option>
  </select>
</div>

<div class="card">
  <h3>Datos del veh铆culo</h3>

  <label>Patente unidad</label>
  <input id="patente">

  <label>Tipo veh铆culo</label>
  <select id="tipo_vehiculo">
    <option>Camioneta</option>
    <option>Cami贸n</option>
    <option>Bus</option>
    <option>Maquinaria</option>
  </select>

  <label>Marca veh铆culo</label>
  <input id="marca">

  <label>Modelo veh铆culo</label>
  <input id="modelo_vehiculo">

  <label>A帽o veh铆culo</label>
  <input id="anio">
</div>

<div class="card">
  <h3>Datos del radio</h3>

  <label>Producto / Modelo radio</label>
  <input id="modelo">

  <label>N煤mero de Serie</label>
  <input id="serie">

  <label>Tipo servicio</label>
  <select id="tipo">
    <option>Mantenci贸n</option>
    <option>Instalaci贸n</option>
    <option>Revisi贸n</option>
  </select>

  <label>Fecha Venta</label>
  <input type="date" id="fecha_venta">

  <label>Fecha Instalaci贸n</label>
  <input type="date" id="fecha_instalacion">

  <label>Observaciones</label>
  <textarea id="observaciones"></textarea>

  <button onclick="guardarRegistro()">Guardar y Generar QR</button>
</div>

<h3>QR Generado:</h3>
<div id="qr"></div>

<h3> Registros (REGISTRO_ACTUAL):</h3>
<div id="lista"></div>

<script>
//  Pega aqu铆 tu URL de Apps Script (Aplicaci贸n Web)
const API_URL = "https://script.google.com/macros/s/AKfycbzbr0UxNpYLF9hgKtdnrOBlq5OGK78y6-BsnDVPuYy1n1EpCcQchT9V8q3J8x7aw0V9/exec";

// URL base de tu GitHub Pages
const BASE_WEB = "https://snkbcvf.github.io/EXPLORA-SERVICIOS";

function generarID(){
  return "RADIO-" + Date.now();
}

function calcularProxima(fecha){
  if(!fecha) return "";
  const d = new Date(fecha);
  d.setMonth(d.getMonth() + 6);
  return d.toISOString().split("T")[0];
}

function formatoLatino(fechaISO) {
  if(!fechaISO) return "";
  const p = fechaISO.split("-");
  return `${p[2]}/${p[1]}/${p[0]}`;
}

// Guardar nuevo registro (o actualizar si ID existe)
function guardarRegistro() {

  let id = document.getElementById("id_radio").value.trim();
  if (!id) {
    id = generarID();
  }

  const datos = {
    id: id,
    empresa: document.getElementById("empresa").value,
    solicitante: document.getElementById("solicitante").value,
    oc: document.getElementById("oc").value,
    lugar: document.getElementById("lugar").value,
    tecnico: document.getElementById("tecnico").value,
    motivo: document.getElementById("motivo").value,
    patente: document.getElementById("patente").value,
    tipo_vehiculo: document.getElementById("tipo_vehiculo").value,
    marca: document.getElementById("marca").value,
    modelo_vehiculo: document.getElementById("modelo_vehiculo").value,
    anio: document.getElementById("anio").value,
    modelo_radio: document.getElementById("modelo").value,
    serie: document.getElementById("serie").value,
    tipo: document.getElementById("tipo").value,
    fecha_venta: document.getElementById("fecha_venta").value,
    fecha_instalacion: document.getElementById("fecha_instalacion").value,
    prox_mantencion: calcularProxima(
      document.getElementById("fecha_instalacion").value ||
      document.getElementById("fecha_venta").value
    ),
    observaciones: document.getElementById("observaciones").value
  };

  // Enviar a Apps Script (crea o actualiza + bit谩cora)
  fetch(API_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(datos)
  });

  // Mostrar QR con la URL de vista
  generarQR(id);

  // Dejar el ID visible para futuras actualizaciones
  document.getElementById("id_radio").value = id;

  // Recargar panel
  setTimeout(cargarRegistros, 1500);
}

// Generar QR
function generarQR(id) {

  const url = `${BASE_WEB}/vista.html?id=${id}`;

  const qr = qrcode(0, "L");
  qr.addData(url);
  qr.make();

  document.getElementById("qr").innerHTML = "";

  const img = document.createElement("img");
  img.src = qr.createDataURL(6,4);

  document.getElementById("qr").appendChild(img);
}

// Cargar registros desde REGISTRO_ACTUAL
function cargarRegistros() {

  fetch(API_URL + "?all=true")
    .then(r => r.json())
    .then(data => {

      const contenedor = document.getElementById("lista");
      contenedor.innerHTML = "";

      data.forEach(r => {

        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML = `
          <b>ID:</b> ${r[0]}<br>
          <b>Empresa:</b> ${r[1]}<br>
          <b>Solicitante:</b> ${r[2]}<br>
          <b>Lugar:</b> ${r[4]}<br>
          <b>T茅cnico:</b> ${r[5]}<br>
          <b>Motivo:</b> ${r[6]}<br>
          <b>Patente:</b> ${r[7]}<br>
          <b>Veh铆culo:</b> ${r[8]} / ${r[9]} / ${r[10]} / ${r[11]}<br>
          <b>Radio:</b> ${r[12]} (${r[13]})<br>
          <b>Tipo servicio:</b> ${r[14]}<br>
          <b>Fecha venta:</b> ${formatoLatino(r[15])}<br>
          <b>Fecha instalaci贸n:</b> ${formatoLatino(r[16])}<br>
          <b>Pr贸x mantenci贸n:</b> ${formatoLatino(r[17])}<br>
          <b>Obs:</b> ${r[18]}<br>
          <button onclick="generarQR('${r[0]}')">Ver QR</button>
        `;

        contenedor.appendChild(div);
      });
    });
}

// Cargar al entrar
cargarRegistros();
</script>

</body>
</html>
